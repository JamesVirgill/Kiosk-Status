<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kiosk Status</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif !important;
      margin: 0;
      background: #121b1f;
      color: #fff;
      position: relative;
      min-height: 100vh;
    }
    body::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 50%;
      background: url('background-pattern.png') repeat-x;
      background-size: auto;
      opacity: 1;
      z-index: -1;
    }
    .container {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px;
      position: relative; z-index: 1;
    }
    h1 {
      color: #00c0d4; margin-bottom: 20px;
      font-size: 56px; text-align: center;
    }

    /* Tip box as <details> */
    details.tip-box {
      max-width: 900px;
      background: rgba(18, 27, 31, 0.9);
      border: 2px solid #2E3D3E;
      border-radius: 12px;
      padding: 16px 20px;
      margin: 0 auto 40px auto;
      color: #e5e7eb;
      font-size: 0.95rem;
      line-height: 1.6;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    details.tip-box[open] .chev { transform: rotate(180deg); }
    summary.tip-title {
      display: flex; align-items: center; gap: 10px;
      list-style: none; cursor: pointer; color: #facc15;
      font-weight: 700; margin: 0; outline: none;
    }
    summary.tip-title::-webkit-details-marker { display: none; }
    .tip-title svg { width: 20px; height: 20px; flex: 0 0 auto; }
    .tip-title .chev { margin-left: auto; transition: transform 0.2s ease; color: #e5e7eb; font-weight: 600; }
    .tip-content { margin-top: 10px; }
    .tip-content p { margin: 8px 0; }
    .tip-content strong { color: #00c0d4; }

    .card { border-radius: 12px; padding: 20px; margin: 10px; }
    .status-card { background: #151F1F; border: 2px solid #2E3D3E; }
    .poll-card   { background: #1D2A2B; border: 2px solid #2E3D3E; }

    .status-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 40px; flex-wrap: wrap; gap: 10px;
    }
    .status-card h2 { font-size: 28px; font-weight: 600; margin: 0; }

    .company-select {
      padding: 10px; border-radius: 6px; border: none;
      -webkit-appearance: none; -moz-appearance: none;
      background: url('data:image/svg+xml;utf8,<svg fill="white" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 0.5rem center;
      background-color: #212D2E; color: #fff;
      font-family: 'Montserrat', sans-serif;
    }
    .last-update { color: #fcd34d; font-size: 0.8rem; margin: 5px 0 0 0; }

    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left; font-size: 0.8rem; font-weight: 600;
      color: rgba(255,255,255,0.6); padding-bottom: 8px;
    }
    tbody td {
      padding: 20px 0; border-top: 1px solid rgba(255,255,255,0.2);
      font-size: 0.95rem; font-weight: 500;
    }

    .status-up, .status-down {
      display: inline-block; width: 28px; height: 28px;
      line-height: 28px; text-align: center; font-size: 1rem; border-radius: 100%;
    }
    .status-up   { border: 1px solid #10b981; background: rgba(16,185,129,0.15); }
    .status-down { border: 1px solid #ef4444; background: rgba(239,68,68,0.15); }

    .poll-card select, .poll-card input {
      width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: none;
      color: #fff; box-sizing: border-box; font-family: 'Montserrat', sans-serif !important;
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      background: url('data:image/svg+xml;utf8,<svg fill="white" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 0.5rem center;
      background-color: #253031; background-size: 1rem;
    }
    .poll-card button {
      width: 100%; padding: 12px; border-radius: 20px;
      border: 2px solid #facc15; background: transparent; color: #fff;
      font-weight: 600; cursor: pointer; margin-top: 10px; text-transform: uppercase;
    }
    .poll-card button:hover { transition: all 0.4s ease-in-out; background: #facc15; color: #000; }

    .content { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; width: 100%; max-width: 1000px; }
    .status-card { grid-column: span 8; }
    .poll-card   { grid-column: span 4; }

    .section-note { margin: -10px 0 10px 0; color: #e5e7eb; font-size: 0.9rem; opacity: 0.9; }
    .thank-you { margin-top: 20px; color: #0f0; font-weight: bold; display: none; }

    .footer { margin-top: 40px; text-align: center; font-size: 0.9rem; }
    .footer a { color: #00c0d4; text-decoration: none; }
    .footer a:hover { text-decoration: underline; }

    @media (max-width: 768px) {
      .status-card, .poll-card { grid-column: span 12; }
      h1 { font-size: 2rem; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Check Kiosk Status</h1>

    <!-- Collapsible tip box (loads collapsed by default) -->
    <details class="tip-box">
      <summary class="tip-title">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <path d="M12 8h.01M11 11h2v5h-2z" fill="currentColor"/>
        </svg>
        <span>Getting Started</span>
        <span class="chev">▼</span>
      </summary>
      <div class="tip-content">
        <p>Welcome to The Kiosk Status Checker. This app helps you determine whether a kiosk or ATM is up and running before making the trip. Add it to your phone for one-tap access anytime.</p>
        <p><strong>Android:</strong> Tap the three-dot menu, choose “Add to Home screen” (or “Install”), then confirm.</p>
        <p><strong>iOS:</strong> Open this site in Safari, tap the Share button (square with arrow), then “Add to Home Screen.”</p>
      </div>
    </details>

    <div class="content">
      <!-- Status Card -->
      <div class="card status-card">
        <div class="status-header">
          <div>
            <h2>WeChangeUp</h2>
            <div class="last-update" id="lastUpdatedText">Last updated: N/A</div>
          </div>
          <select name="company" class="company-select" required>
            <option value="WeChangeUp">WeChangeUp</option>
            <option value="More Coming Soon">More Coming Soon</option>
          </select>
        </div>

        <table class="status-table">
          <thead>
            <tr>
              <th>Location</th>
              <th style="text-align: center">Status</th>
            </tr>
          </thead>
          <tbody id="status-table-body"></tbody>
        </table>
      </div>

      <!-- Poll Card -->
      <div class="card poll-card">
        <h2>Customer Feedback</h2>
        <p class="section-note">Please tell us which company you’d like to see displayed next.</p>
        <form class="form-container" action="https://formspree.io/f/mzzvekba" method="POST">
          <select name="company" required>
            <option value="">Which company?</option>
            <option value="Quick Pay">Quick Pay</option>
            <option value="RBC">RBC</option>
            <option value="Scotia">Scotia</option>
            <option value="BOB">BOB</option>
            <option value="Commonwealth">Commonwealth</option>
            <option value="CIBC">CIBC</option>
          </select>
          <select name="helpful" required>
            <option value="">Was this site helpful?</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>

          <input type="text" name="name"  placeholder="Your name (optional)" />
          <input type="text" name="phone" placeholder="Phone number (optional)" />
          <input type="text" name="email" placeholder="Email (optional)" />
          <button id="submitButton" type="submit">Submit</button>
          <div class="thank-you" id="thankYouMessage">Thank you! Your poll was received. </div>
        </form>
      </div>
    </div>

    <div class="footer">
      <p>Back to <a href="https://wechangeup.net">WeChangeUp.net</a></p>
    </div>
  </div>

  <!-- App logic -->
  <script type="module">
    import { supabase } from './supabaseClient.js';

    const locationMap = {
      "Smitty's": "Smitty's Sandyport",
      "QHC Carmichael": "Quality Home Center Carmichael",
      "Quality Home Center": "Quality Home Center Prince Charles",
      "Rubis": "Rubis East St and Soldier Rd"
    };

    function formatTime(dateStr) { return new Date(dateStr).toLocaleString(); }

    async function loadStatusFromSupabase() {
      const { data, error } = await supabase
        .from('kiosks')
        .select('*')
        .order('timestamp', { ascending: false });

      if (error) { console.error('Error loading data:', error.message); return; }

      const latestReports = {};
      data.forEach(row => {
        if (!latestReports[row.location] || row.timestamp > latestReports[row.location].timestamp) {
          latestReports[row.location] = row;
        }
      });

      const tbody = document.getElementById("status-table-body");
      tbody.innerHTML = "";
      let latestTime = null;

      Object.entries(locationMap).forEach(([raw, display]) => {
        const report = latestReports[raw];
        let statusIcon = "<span class='status-up'></span>";
        if (report && report.status === "error") statusIcon = "<span class='status-down'></span>";
        if (report) {
          const reportTime = new Date(report.timestamp);
          if (!latestTime || reportTime > latestTime) latestTime = reportTime;
        }
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${display}</td>
          <td style="text-align: center">${statusIcon}</td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById("lastUpdatedText").textContent =
        latestTime ? `Last updated: ${formatTime(latestTime)}` : "Last updated: N/A";
    }

    window.onload = loadStatusFromSupabase;
    setInterval(loadStatusFromSupabase, 5 * 60 * 1000); // Refresh every 5 mins
  </script>
</body>
</html>
