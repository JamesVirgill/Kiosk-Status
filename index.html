
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Machine Status Checker</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    a.back-link {
      align-self: flex-start;
      margin-bottom: 10px;
      color: #0f0;
      text-decoration: none;
      font-weight: bold;
    }
    h1, h2 {
      text-align: center;
    }
    .status-table {
      width: 100%;
      max-width: 600px;
      margin-bottom: 40px;
      border-collapse: collapse;
    }
    .status-table th, .status-table td {
      border: 1px solid #444;
      padding: 10px;
      text-align: center;
    }
    .form-container {
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    select, button, input {
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
    }
    select, input {
      background-color: #222;
      color: #fff;
    }
    button {
      background-color: #0f0;
      color: #000;
      font-weight: bold;
    }
    .thank-you {
      margin-top: 20px;
      color: #0f0;
      font-weight: bold;
      display: none;
    }
    @media (max-width: 600px) {
      .status-table, .form-container {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <a href="https://wechangeup.net/" class="back-link">‚Üê Back to WeChangeUp.net</a>
  <h1>üü¢ Machine Status Check & Report</h1>
  <h2>Current Status</h2>
  <label for="companyFilter">Filter by Company:</label>
  <select id="companyFilter" onchange="filterStatusTable()">
    <option value="WeChangeUp">WeChangeUp</option>
    <option value="Scotiabank">Scotiabank</option>
    <option value="RBC Royal Bank">RBC Royal Bank</option>
    <option value="Commonwealth Bank">Commonwealth Bank</option>
    <option value="CIBC FirstCaribbean">CIBC FirstCaribbean</option>
    <option value="Island Pay">Island Pay</option>
  </select>
  <table class="status-table">
    <thead>
      <tr>
        <th>Company</th>
        <th>Location</th>
        <th>Status</th>
        <th>Last Report</th>
      </tr>
    </thead>
    <tbody id="status-table-body"></tbody>
  </table>

  <h2>üìã Report a Machine</h2>
  <form class="form-container" onsubmit="submitForm(event)">
    <select id="company" onchange="filterLocations()" required>
      <option value="">Which company?</option>
      <option value="WeChangeUp">WeChangeUp</option>
      <option value="Scotiabank">Scotiabank</option>
      <option value="RBC Royal Bank">RBC Royal Bank</option>
      <option value="Commonwealth Bank">Commonwealth Bank</option>
      <option value="CIBC FirstCaribbean">CIBC FirstCaribbean</option>
      <option value="Island Pay">Island Pay</option>
    </select>
    <select id="location" required>
      <option value="">Which location?</option>
    </select>
    <select id="status" required>
      <option value="">Was it working?</option>
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
    <input type="text" id="name" placeholder="Your name (optional for prize)" />
    <input type="text" id="phone" placeholder="Phone number (optional)" />
    <button type="submit">Submit Report</button>
    <div class="thank-you" id="thankYouMessage">Thank you! Your report was received. üéâ</div>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = supabase.createClient(
      "https://uhokqclbxoevlxrzeinf.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVob2txY2xieG9ldmx4cnplaW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1MTg5NDMsImV4cCI6MjA2MzA5NDk0M30.1EtiWsCOnC3cPklPKUNVGJ0M9fFtvAAf0znRDVy9Tqk"
    );

    const locationsByCompany = {
      "WeChangeUp": ["Smitty's Sandyport", "Quality Home Center Carmichael", "Quality Home Center Prince Charles", "Rubis East St and Soldier Rd"],
      "Scotiabank": ["Baha Mar ATM", "Cable Beach Branch", "QVC Pharmacy ATM", "Carmichael Branch", "Dowdeswell St Branch", "Rawson Square Branch", "Thompson Blvd Branch", "Wulff Rd Branch", "Soldier Rd ATM"],
      "RBC Royal Bank": ["RoyalStar Assurance ‚Äì JFK Drive", "Chapter One Bookstore", "West Bay Street Branch", "Shirley Street Branch", "Bay Street Branch", "Madeira Street Branch", "Nassau Central Branch", "SouthWest Plaza Branch", "Prince Charles Branch", "Royal Bank House (Head Office)"],
      "Commonwealth Bank": ["Blue Hill Road", "Cable Beach", "Town Centre Mall", "Robinson Road", "East Bay Street", "Head Office ‚Äì Mackey St", "Wulff Road"],
      "CIBC FirstCaribbean": ["JFK Drive Branch", "Sandyport Branch", "Shirley Street Head Branch", "Thompson Blvd Branch", "Carmichael Branch", "Harbour Bay Branch", "Marathon Road Branch"],
      "Island Pay": ["Caf√© Johnny Canoe ‚Äì Cable Beach", "Commonwealth Supplies SW Plaza", "Commonwealth Supplies PRO Store ‚Äì Robinson Rd", "Esso Bargain City ‚Äì Carmichael Rd", "Kenneth's Food Store ‚Äì Prince Charles Dr", "LPIA Customs Arrival Lounge", "LPIA Domestic Departure", "TAR National Stadium", "Quality Home Centre ‚Äì Carmichael", "Quality Home Centre ‚Äì Prince Charles"]
    };

    let latestReports = [];

    async function submitForm(event) {
      event.preventDefault();
      const company = document.getElementById("company").value;
      const location = document.getElementById("location").value;
      const status = document.getElementById("status").value;
      const name = document.getElementById("name").value;
      const phone = document.getElementById("phone").value;

      if (name && !phone) {
        alert("Please enter your phone number if you provide your name.");
        return;
      }

      latestReports = latestReports.filter(r => !(r.company === company && r.location === location));
      latestReports.push({ company, location, status, time: new Date().toLocaleTimeString() });

      const { error } = await supabase.from("reports").insert({ name, phone, company, location, status });
      if (error) {
        alert("Failed to save report.");
        return;
      }

      document.getElementById("thankYouMessage").style.display = 'block';
      setTimeout(() => {
        document.getElementById("thankYouMessage").style.display = 'none';
      }, 5000);

      event.target.reset();

      if (document.getElementById("companyFilter").value === company) {
        filterStatusTable();
      }
    }

    function filterLocations() {
      const company = document.getElementById("company").value;
      const locationSelect = document.getElementById("location");
      locationSelect.innerHTML = '<option value="">Which location?</option>';
      (locationsByCompany[company] || []).forEach(loc => {
        const option = document.createElement("option");
        option.value = loc;
        option.textContent = loc;
        locationSelect.appendChild(option);
      });
    }

    function filterStatusTable() {
      const selectedCompany = document.getElementById("companyFilter").value;
      const tbody = document.getElementById("status-table-body");
      tbody.innerHTML = "";

      const locations = locationsByCompany[selectedCompany] || [];
      locations.forEach(location => {
        const report = latestReports.find(r => r.company === selectedCompany && r.location === location);
        let symbol = "<span style='color:#ccc'>Unknown</span>";
        let timeText = "No recent reports";
        if (report) {
          const reportDate = new Date();
          const timeParts = report.time.split(":");
          reportDate.setHours(timeParts[0], timeParts[1], 0);
          const twoHoursAgo = new Date();
          twoHoursAgo.setHours(twoHoursAgo.getHours() - 2);
          if (selectedCompany === "WeChangeUp" && report.status === "Yes" && reportDate < twoHoursAgo) {
            symbol = "üü¢";
            timeText = "Just now";
          } else {
            symbol = report.status === "Yes" ? "üü¢" : "üî¥";
            timeText = `Reported at ${report.time}`;
          }
        } else if (selectedCompany === "WeChangeUp") {
          symbol = "üü¢";
          timeText = "Just now";
        }
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${selectedCompany}</td>
          <td>${location}</td>
          <td style="font-size: 20px">${symbol}</td>
          <td>${timeText}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("companyFilter").value = "WeChangeUp";
      filterStatusTable();
    });
  </script>
</body>
</html>
